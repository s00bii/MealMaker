<!DOCTYPE html>
<html>
<head>
  <title>AI Fridge Scanner</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
 <h1>Scan Ingredients with AI</h1>

   <div class="background"></div>

  <div id="cameraWrapper">
    <video id="cameraFeed" autoplay playsinline></video>
    <button id="captureBtn"></button>
  </div>

  <canvas id="snapshotCanvas" style="display:none;"></canvas>

  <div id="previewContainer" style="display:none;">
    <h3>Preview</h3>
    <img id="capturedImage" style="max-width:100%; border-radius: 12px;" />
    <br>
    <button id="retakeBtn">Retake</button>
    <button id="confirmBtn">Confirm & Scan</button>
  </div>

   <!-- Back Button -->
    <div class="back-link">
        <a href="/">‚Üê Back to Fridges</a>
    </div>


  <div id="scanResult">Waiting to scan results...</div>

     <script>
        const video = document.getElementById("cameraFeed");
        const canvas = document.getElementById("snapshotCanvas");
        const captureBtn = document.getElementById("captureBtn");
        const scanResult = document.getElementById("scanResult");
        const previewContainer = document.getElementById("previewContainer");
        const capturedImage = document.getElementById("capturedImage");
        const retakeBtn = document.getElementById("retakeBtn");
        const confirmBtn = document.getElementById("confirmBtn");

        let stream = null;
        const urlParams = new URLSearchParams(window.location.search);
        const fridgeId = urlParams.get("fridge") || "default";

        console.log("‚úÖ JS loaded and fridgeId =", fridgeId);
        console.log("üì∏ confirmBtn:", confirmBtn);

        async function startCamera() {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        }
        function stopCamera() {
            if (!stream) return;
            stream.getTracks().forEach(t => t.stop());
            video.srcObject = null;
        }

        // Start
        startCamera();

        // Capture ‚Üí preview
        captureBtn.onclick = () => {
            const w = video.videoWidth || 640;
            const h = video.videoHeight || 480;
            canvas.width = w; canvas.height = h;
            canvas.getContext("2d").drawImage(video, 0, 0, w, h);

            capturedImage.src = canvas.toDataURL("image/jpeg");
            stopCamera();
            previewContainer.style.display = "block";
            captureBtn.style.display = "none";
        };

        // Retake
        retakeBtn.onclick = () => {
            previewContainer.style.display = "none";
            captureBtn.style.display = "block";
            startCamera();
        };

        // Confirm & Scan ‚Üí POST /scan_image as multipart/form-data
        confirmBtn.onclick = () => {
            canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append("photo", blob, "captured_frame.jpg");
            formData.append("fridge_id", fridgeId);

            const res = await fetch(`${window.location.origin}/scan_image`, {
                method: "POST",
                body: formData
            });

            let result;
            try { result = await res.json(); } catch { result = { status: "error" }; }

            if (result.status === "success") {
                scanResult.innerText = "Detected and added to fridge: " + result.items.join(", ");
            } else {
                scanResult.innerText = "Error: Unable to detect ingredients.";
            }

            previewContainer.style.display = "none";
            }, "image/jpeg");
        };
     </script>

</body>
</html>
